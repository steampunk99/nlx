import{c as A,r as P,j as s,b as v,T as F,y as O,x as M,u as Q,v as y,d as h,z as w,V as K}from"./index-CqXPVSZC.js";import{D as R,a as G}from"./dialog-n4gnCksP.js";import{L as N}from"./loader-circle-Bbd1q_nT.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _=A("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=A("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]),m={WAITING:"waiting",PROCESSING:"processing",SUCCESS:"success",FAILED:"failed",TIMEOUT:"timeout"},E=30,C={waiting:{title:"Enter Mobile Money PIN",description:"Please check your phone and enter your PIN to complete the payment",icon:s.jsx(N,{className:"animate-spin h-12 w-12 text-yellow-500"}),color:"text-yellow-500"},processing:{title:"Processing Payment",description:"Please wait while we confirm your payment",icon:s.jsx(N,{className:"animate-spin h-12 w-12 text-blue-500"}),color:"text-blue-500"},success:{title:"Payment Successful!",description:"Your package has been activated successfully",icon:s.jsx(_,{className:"h-12 w-12 text-green-500"}),color:"text-green-500"},failed:{title:"Payment Failed",description:"The payment could not be processed. Please try again",icon:s.jsx(F,{className:"h-12 w-12 text-red-500"}),color:"text-red-500"},timeout:{title:"Payment Timed Out",description:"The payment took too long to complete. Please try again",icon:s.jsx(W,{className:"h-12 w-12 text-orange-500"}),color:"text-orange-500"}};function $({isOpen:g,status:r,onClose:d,onTimeout:c}){const[i,t]=P.useState(E),a=C[r]||C.processing;return P.useEffect(()=>{let p;return g&&r===m.WAITING&&(p=setInterval(()=>{t(k=>k<=1?(clearInterval(p),c==null||c(),0):k-1)},1e3)),()=>{clearInterval(p),t(E)}},[g,r,c]),s.jsx(R,{open:g,onOpenChange:d,children:s.jsx(G,{className:"sm:max-w-md",children:s.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4 p-6",children:[s.jsx("div",{className:v("rounded-full p-3 bg-opacity-10",a.color),children:a.icon}),s.jsx("h3",{className:v("text-xl font-semibold",a.color),children:a.title}),s.jsx("p",{className:"text-center text-muted-foreground",children:a.description}),r===m.WAITING&&s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Time remaining: ",i,"s"]})]})})})}function D(g={}){const{toast:r}=O(),d=M(),c=Q(),{onPaymentStatusChange:i=()=>{}}=g,t=()=>!!K().accessToken,a=(e,o="Unknown")=>{var l;if(((l=e.response)==null?void 0:l.status)!==401)if(e.response)switch(e.response.status){case 403:r({title:"Access Denied",description:"You do not have permission to access this resource.",variant:"destructive"});break;case 404:r({title:"Resource Not Found",description:"The requested resource could not be found.",variant:"destructive"});break;default:r({title:"Error",description:`An unexpected error occurred: ${e.message}`,variant:"destructive"})}else e.request?r({title:"Network Error",description:"No response received from server. Check your internet connection.",variant:"destructive"}):r({title:"Request Error",description:`Error: ${e.message}`,variant:"destructive"})},{data:p=[],isLoading:k,error:I}=y({queryKey:["packages"],queryFn:async()=>{if(console.log("Fetching Packages - Authentication Check"),!t())return console.warn("Not authenticated - redirecting to login"),c("/login"),[];try{console.log("Attempting to fetch packages");const{data:e}=await h.get("/packages");return console.log("Packages fetched successfully:",e),e.data||[]}catch(e){return console.error("Packages fetch error:",e),a(e,"Packages Fetch"),[]}},enabled:t(),retry:1,staleTime:1e3*60*5,onError:e=>{console.error("Query error in packages:",e),a(e,"Packages Query")}}),{data:b=[],isLoading:T,error:S,refetch:U}=y({queryKey:["userPackages"],queryFn:async()=>{var u;const e=await h.get("/packages/user");console.log("Raw Response:",e);const o=(u=e.data)==null?void 0:u.data;return o?[o]:[]},enabled:t()}),L=b||[],{data:j=null,isLoading:q}=y({queryKey:["packageUpgradeOptions"],queryFn:async()=>{if(console.log("Fetching Upgrade Options - Authentication Check"),!t())return console.warn("Not authenticated - redirecting to login"),c("/login"),null;try{console.log("Attempting to fetch upgrade options");const{data:e}=await h.get("/packages/upgrade-options");return console.log("Upgrade options fetched successfully:",e),e.data||null}catch(e){return console.error("Upgrade options fetch error:",e),a(e,"Upgrade Options Fetch"),null}},enabled:t(),retry:1,staleTime:1e3*60*5,onError:e=>{console.error("Query error in upgrade options:",e),a(e,"Upgrade Options Query")}}),f=w({mutationFn:async e=>{if(!(e!=null&&e.phoneNumber))throw new Error("Phone number is required");return(await h.post("/payments/package",{trans_id:e.trans_id,packageId:e.packageId,amount:e.amount,phone:e.phoneNumber})).data},onSuccess:e=>{let o=0;const l=6,u=setInterval(async()=>{try{if(o++,o>=l){clearInterval(u),i==null||i(m.TIMEOUT);return}if(console.log("Data:",e.data.status),!e.data.status)throw new Error("No mobile money response");e.data.status==="SUCCESS"&&(clearInterval(u),i==null||i(m.SUCCESS),d.invalidateQueries({queryKey:["userPackages"]}),setTimeout(()=>{c("/dashboard/packages")},2e3))}catch(n){console.error("Status check failed:",n)}},55e3)}}),x=w({mutationFn:async({currentPackageId:e,newPackageId:o,paymentMethod:l,phoneNumber:u=""})=>{if(console.log("Package Upgrade - Authentication Check"),!t())throw console.warn("Not authenticated - redirecting to login"),c("/login"),new Error("Not authenticated");try{console.log("Attempting package upgrade",{currentPackageId:e,newPackageId:o,paymentMethod:l});const{data:n}=await h.post("/packages/upgrade",{currentPackageId:e,newPackageId:o,paymentMethod:l,phoneNumber:u});return console.log("Package upgrade successful:",n),n}catch(n){throw console.error("Package upgrade error:",n),a(n,"Package Upgrade"),n}},onSuccess:e=>{r({title:"Package Upgraded",description:e.message||"Package upgraded successfully",variant:"default"}),d.invalidateQueries({queryKey:["userPackages"]}),d.invalidateQueries({queryKey:["packages"]})},onError:e=>{console.error("Package upgrade mutation error:",e),a(e,"Package Upgrade Mutation")}});return{availablePackages:p,activePackages:L,upgradeOptions:j,packagesLoading:k||!t(),activePackagesLoading:T||!t(),upgradeOptionsLoading:q||!t(),packagesError:I,activePackagesError:S,purchasePackage:f.mutate,upgradePackage:x.mutate,purchasePackageMutation:f,upgradePackageMutation:x,refetchActivePackages:U}}export{$ as P,m as a,D as u};
