generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int            @id @default(autoincrement())
  username          String         @unique
  email             String         @unique
  password          String
  firstName         String
  lastName          String
  phone             String
  status            String         @default("ACTIVE")
  role              Role           @default(USER)
  isVerified        Boolean        @default(false)
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  country           String         @default("UG")
  announcements     Announcement[] @relation("CreatedBy")
  sourceCommissions Commission[]   @relation("CommissionSource")
  commissions       Commission[]
  node              Node?
  notifications     Notification[] @relation("NotificationUser")
  referralLinks     ReferralLink[]
  reports           Report[]
  sessions          Session[]
  withdrawals       Withdrawal[]

  @@map("users")
}

model Node {
  id          Int       @id @default(autoincrement())
  userId      Int       @unique @map("user_id")
  user        User      @relation(fields: [userId], references: [id])
  position    String    @default("ONE")
  status      String    @default("ACTIVE")
  level       Int       @default(1)
  sponsorId   Int?      @map("sponsor_id")
  placementId Int?      @map("placement_id")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  package     NodePackage?
  payments    NodePayment[]
  statements  NodeStatement[]
  withdrawals NodeWithdrawal[]
  parent      Node?            @relation("TreeStructure", fields: [placementId], references: [id])
  children    Node[]           @relation("TreeStructure")
  sponsor     Node?            @relation("SponsorRelation", fields: [sponsorId], references: [id])
  sponsored   Node[]           @relation("SponsorRelation")

  @@index([placementId], map: "nodes_placement_id_fkey")
  @@index([sponsorId], map: "nodes_sponsor_id_fkey")
  @@map("nodes")
}

model Package {
  id           Int           @id @default(autoincrement())
  name         String
  description  String?       @db.Text
  price        Decimal       @db.Decimal(10, 2)
  level        Int
  status       String        @default("ACTIVE")
  benefits     Json?
  maxNodes     Int           @default(1)
  duration     Int           @default(30)
  features     String?       @db.Text
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  commissions  Commission[]
  nodePackages NodePackage[]

  @@map("packages")
}

model NodePackage {
  id        Int      @id @default(autoincrement())
  nodeId    Int      @unique @map("node_id")
  packageId Int      @map("package_id")
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  node      Node     @relation(fields: [nodeId], references: [id])
  package   Package  @relation(fields: [packageId], references: [id])

  @@index([packageId], map: "node_packages_package_id_fkey")
  @@map("node_packages")
}

model NodePayment {
  id        Int           @id @default(autoincrement())
  nodeId    Int           @map("node_id")
  amount    Decimal       @db.Decimal(10, 2)
  status    PaymentStatus @default(PENDING)
  type      String
  reference String?
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  node      Node          @relation(fields: [nodeId], references: [id])

  @@index([nodeId], map: "node_payments_node_id_fkey")
  @@map("node_payments")
}

model NodeStatement {
  id          Int      @id @default(autoincrement())
  nodeId      Int      @map("node_id")
  amount      Decimal  @db.Decimal(10, 2)
  type        String
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  node        Node     @relation(fields: [nodeId], references: [id])

  @@index([nodeId], map: "node_statements_node_id_fkey")
  @@map("node_statements")
}

model NodeWithdrawal {
  id             Int              @id @default(autoincrement())
  nodeId         Int              @map("node_id")
  amount         Decimal          @db.Decimal(10, 2)
  status         WithdrawalStatus @default(PENDING)
  reason         String?          @db.Text
  paymentPhone   String?          @map("payment_phone_number")
  paymentType    String           @default("mobile money") @map("payment_type")
  withdrawalDate DateTime?        @map("withdrawal_date")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  node           Node             @relation(fields: [nodeId], references: [id])

  @@index([nodeId], map: "node_withdrawals_node_id_fkey")
  @@map("node_withdrawals")
}

model Commission {
  id           Int              @id @default(autoincrement())
  userId       Int              @map("user_id")
  amount       Decimal          @db.Decimal(15, 2)
  type         CommissionType
  description  String?          @db.Text
  status       CommissionStatus @default(PENDING)
  sourceUserId Int?             @map("source_user_id")
  packageId    Int?             @map("package_id")
  processedAt  DateTime?        @map("processed_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  package      Package?         @relation(fields: [packageId], references: [id])
  sourceUser   User?            @relation("CommissionSource", fields: [sourceUserId], references: [id])
  user         User             @relation(fields: [userId], references: [id])

  @@index([packageId], map: "commissions_package_id_fkey")
  @@index([sourceUserId], map: "commissions_source_user_id_fkey")
  @@index([userId], map: "commissions_user_id_fkey")
  @@map("commissions")
}

model Announcement {
  id          Int              @id @default(autoincrement())
  title       String
  content     String           @db.Text
  type        AnnouncementType @default(GENERAL)
  priority    Priority         @default(LOW)
  status      String           @default("DRAFT")
  createdBy   Int              @map("created_by")
  publishDate DateTime?        @map("publish_date")
  expiryDate  DateTime?        @map("expiry_date")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  author      User             @relation("CreatedBy", fields: [createdBy], references: [id])

  @@index([createdBy], map: "announcements_created_by_fkey")
  @@map("announcements")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  title     String
  message   String   @db.Text
  type      String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation("NotificationUser", fields: [userId], references: [id])

  @@index([userId], map: "notifications_user_id_fkey")
  @@map("notifications")
}

model Report {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String
  data      Json
  status    String   @default("PENDING")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "reports_user_id_fkey")
  @@map("reports")
}

model Withdrawal {
  id        Int              @id @default(autoincrement())
  userId    Int              @map("user_id")
  amount    Decimal          @db.Decimal(10, 2)
  status    WithdrawalStatus @default(PENDING)
  method    String
  details   Json?
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId], map: "withdrawals_user_id_fkey")
  @@map("withdrawals")
}

model Session {
  id         String   @id
  userId     Int      @map("user_id")
  userAgent  String?
  ipAddress  String?
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("sessions")
}

model ReferralLink {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  username    String
  code        String   @unique
  link        String   @unique
  clicks      Int      @default(0)
  conversions Int      @default(0)
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "referral_links_user_id_fkey")
  @@map("referral_links")
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum AnnouncementType {
  GENERAL
  MAINTENANCE
  UPDATE
  PROMOTION
  EMERGENCY
}

enum CommissionType {
  DIRECT
  MATCHING
  LEVEL
}

enum CommissionStatus {
  PENDING
  PROCESSED
  FAILED
}

enum Position {
  ONE
  TWO
  THREE
}
